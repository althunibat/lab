---
- name: Checks the docker version.
  shell: if which docker; then docker --version; else echo "No"; fi
  register: docker_version

- name: Checks the python-pip version.
  shell: if which pip; then pip --version; else echo "No"; fi
  register: pip_version

- name: Checks the docker-py version.
  shell: if which pip; then if ! pip show docker-py; then echo "No"; fi else echo "No"; fi
  register: docker_py_version

- name: create docker swarm manager
  hosts: docker-manager-first
  tasks:
  - name: "create primary swarm manager"
    shell: docker swarm init --advertise-addr {{ ansible_eth0['ipv4']['address'] }}
    when: "docker_info.stdout.find('Swarm: inactive') != -1"

  - name: "get docker swarm manager token"
    shell: docker swarm join-token -q manager
    register: manager_token

  - name: "get docker swarm worker token"
    shell: docker swarm join-token -q worker
    register: worker_token
  
- name: join docker swarm managers
  hosts: docker-managers
  tasks:
  - name: "join as a manager"
    shell: "docker swarm join --token {{ hostvars['manager1']['manager_token']['stdout'] }} {{ hostvars['manager1']['ansible_eth0']['ipv4']['address'] }}:2377"
    when: docker_info.stdout.find("Swarm{{':'}} inactive") != -1
    retries: 3
    delay: 20
  
- name: join docker swarm workers
  hosts: docker-workers
  tasks:
  - name: "join as a worker"
    shell: "docker swarm join --token {{ hostvars['manager1']['worker_token']['stdout'] }} {{ hostvars['manager1']['ansible_eth0']['ipv4']['address'] }}:2377"
    when: "docker_info.stdout.find('Swarm: inactive') != -1"
    retries: 3
    delay: 20